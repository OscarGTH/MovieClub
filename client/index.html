<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script
      crossorigin
      src="https://unpkg.com/react@16/umd/react.development.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"
    ></script>
    <script
      src="https://unpkg.com/@material-ui/core/umd/material-ui.development.js"
      crossorigin="anonymous"
    ></script>
    <title>My app</title>
  </head>
  <style>
    body {
      font-family: Arial;
      font-size: 17px;
    }
  </style>
  <body>
    <div id="app"></div>
    <div id="userInfo"></div>
    <script type="text/babel">
      const {
        Button,
        Paper,
        TextField,
        MuiThemeProvider,
        Typography,
        withStyles,
        Toolbar,
        AppBar
      } = window["material-ui"];

      class App extends React.Component {
        constructor() {
          super();
          this.state = {
            auth: false,
            user: "",
            token: ""
          };
          this.setAuthenticate = this.setAuthenticate.bind(this);
        }

        setAuthenticate(status, auth_user, token) {
          this.setState({
            user: auth_user,
            auth: true,
            token: token
          });
        }
        render() {
          return (
            <div className="App">
              <MuiThemeProvider>
                <Paper className="paper">
                  {this.state.auth ? (
                    <MainMenu user={this.state.user} token={this.state.token} />
                  ) : (
                    <LoginForm onAuthenticate={this.setAuthenticate} />
                  )}
                </Paper>
              </MuiThemeProvider>
            </div>
          );
        }
      }

      class MainMenu extends React.Component {
        constructor(props) {
          super(props);
          this.state = {
            currentUser: this.props.user,
            users: [],
            showUsers: false,
            showEvents: false,
            token: this.props.token
          };
        }

        showUsers = value => () => {
          this.setState({
            showUsers: value
          });
        };
        showEvents = () => {
          this.setState({
            showEvents: !this.state.showEvents
          });
        };

        render() {
          return (
            <MuiThemeProvider>
              <Paper className="paper">
                <AppBar position="static">
                  <Toolbar>
                    <Typography variant="h6" color="inherit">
                      Settings
                    </Typography>
                  </Toolbar>
                </AppBar>
                <h3> Welcome to the main page of movie club! </h3>
                <p> Logged in as {this.state.currentUser.email}</p>
                <Button onClick={this.showEvents}>Upcoming events</Button>
                <Button onClick={this.showUsers(true)}>List of users</Button>
                <Button>Edit your account info</Button>
                <Button>Pay membership fee</Button>
                <Button>Log out</Button>
                {this.state.showEvents && (
                  <EventList token={this.state.token} user={this.state.user} />
                )}
                {this.state.showUsers && (
                  <UserList
                    token={this.state.token}
                    user={this.state.currentUser}
                  />
                )}
              </Paper>
            </MuiThemeProvider>
          );
        }
      }
      // Class for
      class UserList extends React.Component {
        constructor(props) {
          super(props);
          this.state = {
            admin: this.props.user.role,
            currentUser: this.props.user,
            users: [],
            token: this.props.token,
            message: ""
          };
        }
        componentDidMount() {
          this.getAllUsers();
        }

        // Fetch all users.
        getAllUsers = () => {
          fetch("http://localhost:3000/api/user", {
            method: "GET",
            mode: "cors",
            headers: {
              "Content-type": "application/json",
              Authorization: "Bearer " + this.state.token
            },
            cache: "no-cache"
          }).then(res => {
            res.json().then(body => {
              if (res.status == 200) {
                this.setState({
                  users: body.message
                });
              } else {
                this.setState({
                  message: JSON.stringify(body.message)
                });
              }
            });
          });
        };

        editUser = id => () => {
          console.log("Editing user with id " + id);
        };

        // Deletes selected user
        deleteUser = id => () => {
          fetch("http://localhost:3000/api/user/" + id, {
            method: "DELETE",
            mode: "cors",
            headers: {
              "Content-type": "application/json",
              Authorization: "Bearer " + this.state.token
            },
            cache: "no-cache"
          }).then(res => {
            res.json().then(body => {
              // If deletion is succesfull, update userlist.
              if (res.status == 200) {
                this.getAllUsers();
              } else {
                // If deletion failed, show error message.
                this.setState({
                  message: body.message
                });
              }
            });
          });
        };

        render() {
          return (
            <MuiThemeProvider>
              <Paper>
                <div>
                  {/* List all users */}
                  {this.state.users.map((user, key) => (
                    <ul key={user.id}>
                      <li>
                        <b> Email:</b> {user.email}
                        <b> Role:</b> {user.role ? <u> Admin </u> : "Basic"}
                        {/*If the user is admin, show if the users have paid and two buttons for editing and deleting the users.*/}
                        {this.state.admin ? (
                          <div>
                            <div>
                              <b> Paid: </b> {user.paid ? "Yes" : "No"}
                            </div>
                            <Button
                              onClick={this.editUser(user.userId)}
                              className="btn"
                            >
                              Edit user
                            </Button>
                            <Button
                              onClick={this.deleteUser(user.userId)}
                              className="btn"
                            >
                              Delete user
                            </Button>
                          </div>
                        ) : null}
                      </li>
                    </ul>
                  ))}
                </div>
              </Paper>
            </MuiThemeProvider>
          );
        }
      }

      class LoginForm extends React.Component {
        constructor(props) {
          super(props);
          this.state = {
            email: "",
            password: "",
            showRegister: false,
            message: ""
          };
        }

        auth = (status, user, token) => {
          this.props.onAuthenticate(status, user, token);
        };

        // Logs the user in.
        login = event => {
          // Create an user object
          var user = {
            email: this.state.email,
            password: this.state.password
          };
          // Send ajax call to server with username and password.
          fetch("http://localhost:3000/api/login", {
            credentials: "same-origin",
            headers: {
              "Content-Type": "application/json"
            },
            method: "POST",
            body: JSON.stringify(user)
          }).then(res => {
            res.json().then(body => {
              if (res.status == 200) {
                this.auth(res.status, body.message, body.token);
              } else {
                this.setState({
                  message: (body.message)
                });
              }
            });
          });
        };
        // Handle text field changes
        handleChange = name => event => {
          this.setState({
            [name]: event.target.value
          });
        };

        handleRegister = (status, message) => {
          this.setState({
            message: message,
            showRegister: false
          });
        };

        toggleRegister = event => {
          this.setState({
            showRegister: !this.state.showRegister
          });
        };

        render() {
          return (
            <MuiThemeProvider>
              <Paper className="paper">
                <h2> Movie club member login </h2>
                <div>{this.state.message}</div>
                <TextField
                  label="Email"
                  value={this.state.email}
                  onChange={this.handleChange("email")}
                />
                <TextField
                  label="Password"
                  value={this.state.password}
                  onChange={this.handleChange("password")}
                />
                <Button onClick={this.login}>Login</Button>
                <Button onClick={this.toggleRegister}>Register</Button>
                <Button onClick={this.guestlogin}>Continue as guest</Button>
                <div>
                  {this.state.showRegister && (
                    <RegisterForm onClose={this.handleRegister} />
                  )}
                </div>
              </Paper>
            </MuiThemeProvider>
          );
        }
      }

      class RegisterForm extends React.Component {
        constructor(props) {
          super(props);
          this.state = {
            email: "",
            password: "",
            role: ""
          };
        }

        // Handle text field changes
        handleChange = name => event => {
          this.setState({
            [name]: event.target.value
          });
        };

        // Registers an user to the system.
        register = () => {
          // Create an user object
          var user = {
            email: this.state.email,
            password: this.state.password,
            role: this.state.role
          };
          // Send ajax call to server with username and password.
          fetch("http://localhost:3000/api/user", {
            credentials: "same-origin",
            headers: {
              "Content-Type": "application/json"
            },
            method: "POST",
            body: JSON.stringify(user)
          }).then(res => {
            res.json().then(body => {
              if (res.status != 400) {
                this.props.onClose(body.message);
              } else {
                this.props.onClose(body.message);
              }
            });
          });
        };

        render() {
          return (
            <MuiThemeProvider>
              <Paper>
                <TextField
                  label="Email"
                  value={this.state.email}
                  onChange={this.handleChange("email")}
                />

                <TextField
                  label="Password"
                  value={this.state.password}
                  onChange={this.handleChange("password")}
                />

                <TextField
                  label="Role"
                  value={this.state.role}
                  onChange={this.handleChange("role")}
                />

                <Button onClick={this.register}>Register</Button>
              </Paper>
            </MuiThemeProvider>
          );
        }
      }
      class EventList extends React.Component {
        constructor(props) {
          super(props);
          this.state = {
            currentUser: this.props.user,
            events: []
          };
        }

        componentDidMount() {
          fetch("http://localhost:3000/api/events")
            .then(res => res.json())
            .then(json => this.setState({ events: json }));
        }
        render() {
          return (
            <MuiThemeProvider>
              <Paper>
                <div>
                  {this.state.events.map(event => (
                    <ul key={event.key}>
                      <li>
                        <b>What? </b> {event.name}
                        <b>Where? </b>
                        {this.state.currentUser !== undefined
                          ? event.location
                          : "Information only available for registered users"}
                        <b>When? </b> {event.date}
                        <b>Cost? </b> {event.price} euros
                      </li>
                    </ul>
                  ))}
                </div>
              </Paper>
            </MuiThemeProvider>
          );
        }
      }

      ReactDOM.render(<App />, document.getElementById("app"));
    </script>
  </body>
</html>
