<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script
      crossorigin
      src="https://unpkg.com/react@16/umd/react.development.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"
    ></script>
    <script
      src="https://unpkg.com/@material-ui/core/umd/material-ui.development.js"
      crossorigin="anonymous"
    ></script>
    <title>My app</title>
  </head>
  <style>
      body {
        font-family: Arial;
        font-size: 17px;
        background-image: url("https://static.vecteezy.com/system/resources/previews/000/250/856/large_2x/mountain-view-vector-design.jpg");
        background-size: cover;
        overflow: "hidden";
      }
      .buttonDiv {
        margin: 5px;
      }
      #signup {
        margin: 5px;
        color: cornflowerblue;
      }
      #signup:hover {
        color: darkblue;
      }


    }
  </style>
  <body>
    <div id="app"></div>
    <div id="userInfo"></div>
    <script type="text/babel">
      const url = "http://localhost:3000/api/";
      const {
        Button,
        Paper,
        TextField,
        MuiThemeProvider,
        Typography,
        Toolbar,
        AppBar,
        Dialog,
        DialogTitle,
        DialogContent,
        DialogActions,
        Grid
      } = window["material-ui"];

      class App extends React.Component {
        constructor() {
          super();
          this.state = {
            auth: false,
            user: "",
            token: "",
            guest: false
          };
          this.setAuthenticate = this.setAuthenticate.bind(this);
          this.handleLogout = this.handleLogout.bind(this);
        }

        setAuthenticate = (status, auth_user, token) => {
          // Check that the user is not guest.
          if (auth_user.role != 2) {
            this.setState({
              user: auth_user,
              auth: true,
              token: token
            });
          } else {
            this.setState({
              auth: true,
              user: auth_user
            });
          }
        };
        // Function to logout.
        handleLogout = () => {
          if (this.state.user.role != 2) {
            fetch(url + "logout", {
              method: "GET",
              mode: "cors",
              headers: {
                "Content-type": "application/json",
                Authorization: "Bearer " + this.state.token
              },
              cache: "no-cache"
            }).then(
              this.setState({
                auth: false
              })
            );
          } else {
            this.setState({
              auth: false
            });
          }
        };

        render() {
          return (
            <div className="App">
              <MuiThemeProvider>
                <h1> Movie club </h1>
                {this.state.auth ? (
                  <Paper className="paper">
                    <MainMenu
                      user={this.state.user}
                      token={this.state.token}
                      onLogout={this.handleLogout}
                    />
                  </Paper>
                ) : (
                  <Grid
                    container
                    spacing={0}
                    direction="column"
                    alignItems="center"
                    justify="center"
                    style={{ minHeight: "100vh" }}
                  >
                    <Grid item xs={3}>
                      <LoginForm onAuthenticate={this.setAuthenticate} />
                    </Grid>
                  </Grid>
                )}
              </MuiThemeProvider>
            </div>
          );
        }
      }

      class MainMenu extends React.Component {
        constructor(props) {
          super(props);
          this.state = {
            currentUser: this.props.user,
            users: [],
            handleUsers: false,
            handleEvents: false,
            token: this.props.token,
            showDialog: false,
            showPayment: false
          };
          this.handleDialogUpdate = this.handleDialogUpdate.bind(this);
        }
        // Handles the logging out
        handleLogout = () => {
          this.props.onLogout();
        };
        // Handles the closing and opening of user list component
        handleUsers = () => {
          this.setState({
            handleUsers: !this.state.handleUsers
          });
        };
        // Handles the closing and opening of event component
        handleEvents = () => {
          this.setState({
            handleEvents: !this.state.handleEvents
          });
        };

        // Handles dialog user editing. Gets updated user data from dialog component
        handleDialogUpdate = user => {
          console.log("Called dialog update.");
          if (user !== "undefined") {
            fetch(url + "user/" + user.userId, {
              method: "PUT",
              mode: "cors",
              headers: {
                "Content-type": "application/json",
                Authorization: "Bearer " + this.state.token
              },
              cache: "no-cache",
              body: JSON.stringify(user)
            });
          }
          this.handleDialog();
        };

        // Handles dialog closing
        handleDialog = () => {
          this.setState({
            showDialog: !this.state.showDialog
          });
        };

        deleteUser = id => {
          fetch("http://localhost:3000/api/user/" + id, {
            method: "DELETE",
            mode: "cors",
            headers: {
              "Content-type": "application/json",
              Authorization: "Bearer " + this.state.token
            },
            cache: "no-cache"
          }).then(res => {
            res.json().then(body => {
              console.log(body.message);
              // If deletion is succesfull, update userlist.
              if (res.status == 200) {
                this.props.onLogout();
              } else {
                // If deletion failed, show error message.
                this.setState({
                  message: body.message
                });
              }
            });
          });
        };
        // Sets the payment status of the user true when payment is done.
        handlePayment = () => {
          var user = this.state.currentUser;
          user.paid = true;
          this.setState({
            currentUser: user
          });
          this.showPayment();
        };

        // Toggles the payment visibility on and off.
        showPayment = () => {
          this.setState({
            showPayment: !this.state.showPayment
          });
        };

        render() {
          return (
            <MuiThemeProvider>
              <div className="test">
                <Paper className="paper">
                  <h3> Welcome to the main page of movie club! </h3>
                  <p>
                    Logged in as <b> {this.state.currentUser.email} </b>
                  </p>
                  <Button
                    style={{ backgroundColor: "Lavender" }}
                    onClick={this.handleEvents}
                  >
                    Upcoming events
                  </Button>
                  {this.state.handleEvents && (
                    <EventList user={this.state.currentUser} />
                  )}
                  {this.state.currentUser.role != 2 ? (
                    <div>
                      <div className="buttonDiv">
                        <Button
                          style={{ backgroundColor: "Lavender" }}
                          onClick={this.handleUsers}
                        >
                          List of users
                        </Button>
                      </div>
                      <div className="buttonDiv">
                        <Button
                          style={{ backgroundColor: "Lavender" }}
                          onClick={this.handleDialog}
                        >
                          Edit your account info
                        </Button>
                      </div>
                      {!this.state.currentUser.paid ? (
                        <div className="buttonDiv">
                          <Button
                            style={{ backgroundColor: "Lavender" }}
                            onClick={this.showPayment}
                          >
                            Pay membership fee
                          </Button>
                        </div>
                      ) : null}
                      <div className="buttonDiv">
                        <Button
                          style={{ backgroundColor: "Lavender" }}
                          onClick={this.handleLogout}
                        >
                          Log out
                        </Button>
                      </div>

                      {this.state.handleUsers && (
                        <UserList
                          token={this.state.token}
                          user={this.state.currentUser}
                        />
                      )}
                      {this.state.showDialog && (
                        <EditUserDialog
                          onDelete={this.deleteUser}
                          onEdit={this.handleDialogUpdate}
                          onCancel={this.handleDialog}
                          targetUser={this.state.currentUser}
                          currentUser={this.state.currentUser}
                        />
                      )}
                      {this.state.showPayment && (
                        <PaymentForm onPay={this.handlePayment} />
                      )}
                    </div>
                  ) : (
                    <div>
                      <div className="buttonDiv">
                        <Button
                          onClick={this.props.onLogout}
                          style={{ backgroundColor: "Lavender" }}
                        >
                          Member login
                        </Button>
                      </div>
                    </div>
                  )}
                </Paper>
              </div>
            </MuiThemeProvider>
          );
        }
      }
      // Class for displaying user list and some functionality.
      class UserList extends React.Component {
        constructor(props) {
          super(props);
          this.state = {
            admin: this.props.user.role,
            currentUser: this.props.user,
            token: this.props.token,
            users: [],
            message: "",
            showDialog: false,
            selectedUser: ""
          };
          this.handleDelete = this.handleDelete.bind(this);
          this.deleteUser = this.deleteUser.bind(this);
        }
        componentDidMount() {
          this.getAllUsers();
        }

        // Handles dialog user editing. Gets updated user data from dialog component
        handleDialogUpdate = user => {
          if (user !== "undefined") {
            fetch(url + "user/" + user.userId, {
              method: "PUT",
              mode: "cors",
              headers: {
                "Content-type": "application/json",
                Authorization: "Bearer " + this.state.token
              },
              cache: "no-cache",
              body: JSON.stringify(user)
            }).then(res => {
              if (res.status == 200) {
                this.getAllUsers();
                this.setState({
                  message: "Successfully edited user"
                });
              }
            });
          }
          this.handleDialog();
        };

        // Handles dialog closing
        handleDialog = () => {
          this.setState({
            showDialog: !this.state.showDialog
          });
        };

        // Fetch all users.
        getAllUsers = () => {
          fetch("http://localhost:3000/api/user", {
            method: "GET",
            mode: "cors",
            headers: {
              "Content-type": "application/json",
              Authorization: "Bearer " + this.state.token
            },
            cache: "no-cache"
          }).then(res => {
            res.json().then(body => {
              if (res.status == 200) {
                this.setState({
                  users: body.message
                });
              } else {
                this.setState({
                  message: JSON.stringify(body.message)
                });
              }
            });
          });
        };

        editUser = user => () => {
          this.setState({
            selectedUser: user,
            showDialog: !this.state.showDialog
          });
        };

        // Deletes selected user based on id.
        deleteUser = id => {
          fetch("http://localhost:3000/api/user/" + id, {
            method: "DELETE",
            mode: "cors",
            headers: {
              "Content-type": "application/json",
              Authorization: "Bearer " + this.state.token
            },
            cache: "no-cache"
          }).then(res => {
            res.json().then(body => {
              // If deletion is succesfull, update userlist.
              if (res.status == 200) {
                this.getAllUsers();
              }
              this.setState({
                message: body.message
              });
            });
          });
        };

        // Handles deletion from EditUserDialog component.
        handleDelete = id => {
          this.handleDialog();
          this.deleteUser(id);
        };

        render() {
          return (
            <MuiThemeProvider>
              <Paper>
                <div>
                  {/* List all users */}
                  <h4>{this.state.message}</h4>
                  {this.state.users.map((user, key) => (
                    <ul key={user.id}>
                      <li>
                        <b> Email:</b> {user.email}
                        <b> Role:</b> {user.role ? <u> Admin </u> : "Basic"}
                        {/*If the user is admin, show if the users have paid and two buttons for editing and deleting the users.*/}
                        {this.state.admin ? (
                          <div>
                            <div>
                              <b> Paid: </b> {user.paid ? "Yes" : "No"}
                            </div>
                            <div className="buttonDiv">
                              <Button
                                style={{ backgroundColor: "Lavender" }}
                                onClick={this.editUser(user)}
                                className="button"
                              >
                                Edit user
                              </Button>
                            </div>
                            {this.state.currentUser.email != user.email ? (
                              <div className="buttonDiv">
                                <Button
                                  style={{ backgroundColor: "Lavender" }}
                                  onClick={() => this.deleteUser(user.userId)}
                                  className="button"
                                >
                                  Delete user
                                </Button>
                              </div>
                            ) : null}
                          </div>
                        ) : null}
                      </li>
                    </ul>
                  ))}
                  {this.state.showDialog ? (
                    <EditUserDialog
                      onDelete={this.handleDelete}
                      onEdit={this.handleDialogUpdate}
                      onCancel={this.handleDialog}
                      targetUser={this.state.selectedUser}
                      currentUser={this.state.currentUser}
                    />
                  ) : null}
                </div>
              </Paper>
            </MuiThemeProvider>
          );
        }
      }

      class LoginForm extends React.Component {
        constructor(props) {
          super(props);
          this.state = {
            email: "",
            password: "",
            showRegister: false,
            message: ""
          };
          this.handleRegister = this.handleRegister.bind(this);
        }

        auth = (status, user, token) => {
          this.props.onAuthenticate(status, user, token);
        };

        // Logs the user in.
        login = event => {
          // Create an user object
          var user = {
            email: this.state.email,
            password: this.state.password
          };
          // Send ajax call to server with username and password.
          fetch("http://localhost:3000/api/login", {
            credentials: "same-origin",
            headers: {
              "Content-Type": "application/json"
            },
            method: "POST",
            body: JSON.stringify(user)
          }).then(res => {
            res.json().then(body => {
              if (res.status == 200) {
                this.auth(res.status, body.message, body.token);
              } else {
                this.setState({
                  message: body.message
                });
              }
            });
          });
        };
        // Handle text field changes
        handleChange = name => event => {
          this.setState({
            [name]: event.target.value
          });
        };
        // Called when registration is done. Update state of message and close registration tab.
        handleRegister = (email, message) => {
          this.setState({
            email: email,
            password: "",
            message: message,
            showRegister: false
          });
        };
        // Handles the opening and closing of registration tab.
        toggleRegister = event => {
          this.setState({
            showRegister: !this.state.showRegister
          });
        };

        handleGuestlogin = () => {
          var user = { email: "Guest", role: 2 };
          this.props.onAuthenticate(undefined, user, undefined);
        };

        render() {
          return (
            <MuiThemeProvider>
              <Paper className="loginform">
                <h2> Sign in </h2>
                <div>{this.state.message}</div>
                <TextField
                  label="Email"
                  value={this.state.email}
                  onChange={this.handleChange("email")}
                />
                <TextField
                  label="Password"
                  value={this.state.password}
                  onChange={this.handleChange("password")}
                />

                <div className="buttonDiv">
                  <Button
                    onClick={this.login}
                    style={{ backgroundColor: "Lavender" }}
                  >
                    Login
                  </Button>
                </div>
                <div className="buttonDiv">
                  <Button
                    onClick={this.handleGuestlogin}
                    style={{ backgroundColor: "Lavender" }}
                  >
                    Continue as guest
                  </Button>
                  <div>
                    <p>
                      Create an account?
                      <a id="signup" onClick={this.toggleRegister}>
                        Sign up
                      </a>
                    </p>
                    {this.state.showRegister && (
                      <RegisterForm onClose={this.handleRegister} />
                    )}
                  </div>
                </div>
              </Paper>
            </MuiThemeProvider>
          );
        }
      }

      // A dialog component to edit selected user.
      class EditUserDialog extends React.Component {
        constructor(props) {
          super(props);
          this.state = {
            currentUser: this.props.currentUser,
            user: this.props.targetUser
          };
        }
        // Calls method from parent component to close the dialog.
        handleCancel = () => {
          this.props.onCancel();
        };
        // Calls method from parent component with edited user as parameter.
        handleEdit = () => {
          this.props.onEdit(this.state.user);
        };

        handleDelete = () => {
          this.props.onDelete(this.state.user.userId);
        };

        // Handles text changes and saves the edited user data into array
        handleChange = field => event => {
          // Copy the user from state
          var user = this.state.user;
          // Change the given parameter with given value
          user[field] = event.currentTarget.value;

          // Set user into state
          this.setState({
            user: user
          });
        };
        render() {
          return (
            <Dialog open={true} onClose={this.handleDialog}>
              <DialogTitle> Edit user information </DialogTitle>
              <DialogContent>
                <div>
                  <TextField
                    value={this.state.user.email}
                    label="Email"
                    onChange={this.handleChange("email")}
                  />
                </div>
                <div>
                  <TextField
                    label="Password"
                    onChange={this.handleChange("password")}
                  />
                </div>
                {/* Show optional editing fields if the user is admin */}
                {this.state.currentUser.role == 1 ? (
                  <div>
                    <div>
                      <TextField
                        value={this.state.user.paid}
                        label="Paid"
                        onChange={this.handleChange("paid")}
                        inputProps={{ maxLength: 5 }}
                      />
                    </div>
                    <div>
                      <TextField
                        value={this.state.user.role}
                        label="Role"
                        onChange={this.handleChange("role")}
                        inputProps={{ maxLength: 1 }}
                      />
                    </div>
                  </div>
                ) : null}
              </DialogContent>

              <DialogActions>
                <Button
                  onClick={this.handleDelete}
                  style={{ backgroundColor: "red" }}
                  variant="outlined"
                  color="primary"
                >
                  Unregister
                </Button>
                <Button
                  onClick={this.handleCancel}
                  variant="outlined"
                  color="primary"
                >
                  Cancel
                </Button>
                <Button
                  onClick={this.handleEdit}
                  variant="outlined"
                  color="primary"
                >
                  Edit
                </Button>
              </DialogActions>
            </Dialog>
          );
        }
      }

      class RegisterForm extends React.Component {
        constructor(props) {
          super(props);
          this.state = {
            email: "",
            password: ""
          };
        }

        // Handle text field changes
        handleChange = name => event => {
          this.setState({
            [name]: event.target.value
          });
        };

        // Close the popup window
        handleCancel = () => {
          this.props.onClose();
        };

        // Registers an user to the system.
        handleRegister = () => {
          // Create an user object
          var user = {
            email: this.state.email,
            password: this.state.password
          };
          // Send ajax call to server with username and password.
          fetch("http://localhost:3000/api/user", {
            credentials: "same-origin",
            headers: {
              "Content-Type": "application/json"
            },
            method: "POST",
            body: JSON.stringify(user)
          }).then(res => {
            res.json().then(body => {
              this.props.onClose(body.email, body.message);
            });
          });
        };

        render() {
          return (
            <Dialog open={true}>
              <DialogTitle> Register to movie club </DialogTitle>
              <DialogContent>
                <div>
                  <TextField
                    label="Email"
                    onChange={this.handleChange("email")}
                  />
                </div>
                <div>
                  <TextField
                    label="Password"
                    onChange={this.handleChange("password")}
                  />
                </div>
              </DialogContent>

              <DialogActions>
                <Button
                  onClick={this.handleRegister}
                  variant="outlined"
                  color="primary"
                >
                  Register
                </Button>
                <Button
                  onClick={this.handleCancel}
                  variant="outlined"
                  color="primary"
                >
                  Cancel
                </Button>
              </DialogActions>
            </Dialog>
          );
        }
      }
      class EventList extends React.Component {
        constructor(props) {
          super(props);
          this.state = {
            currentUser: this.props.user,
            events: []
          };
        }
        /* Fetch events from server */
        componentDidMount() {
          fetch("http://localhost:3000/api/events")
            .then(res => res.json())
            .then(json => this.setState({ events: json }));
        }
        render() {
          return (
            <MuiThemeProvider>
              <Paper style={{ width: "700px" }}>
                <ul>
                  <div>
                    {this.state.events.map(event => (
                      <li key={event.key} style={{ margin: "30px" }}>
                        <div>
                          <b>What? </b> {event.name}
                        </div>
                        <div>
                          <b>Where? </b>
                          {/* Check if the user has logged in and display information depending on that*/}
                          {this.state.currentUser.role != 2
                            ? event.location
                            : "Information only available for registered users"}
                        </div>
                        <div>
                          <b>When? </b> {event.date}
                        </div>
                        <div>
                          <b>Cost? </b> {event.price} euros
                        </div>
                      </li>
                    ))}
                  </div>
                </ul>
              </Paper>
            </MuiThemeProvider>
          );
        }
      }

      class PaymentForm extends React.Component {
        constructor(props) {
          super(props);
        }
        handleClick = () => {
          this.props.onPay();
        };
        render() {
          return (
            <div>
              <Button onClick={this.handleClick}> Pay membership fee </Button>
            </div>
          );
        }
      }

      ReactDOM.render(<App />, document.getElementById("app"));
    </script>
  </body>
</html>
