<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script
      crossorigin
      src="https://unpkg.com/react@16/umd/react.development.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"
    ></script>
    <script
      src="https://unpkg.com/@material-ui/core/umd/material-ui.development.js"
      crossorigin="anonymous"
    ></script>
    <title>My app</title>
  </head>
  <style>
    body {
      font-family: Arial;
      font-size: 17px;
    }
  </style>
  <body>
    <div id="app"></div>
    <div id="userInfo"></div>
    <script type="text/babel">
      const url = "http://localhost:3000/api/";
      const {
        Button,
        Paper,
        TextField,
        MuiThemeProvider,
        Typography,
        Toolbar,
        AppBar,
        Dialog,
        DialogTitle,
        DialogContent,
        DialogActions
      } = window["material-ui"];

      class App extends React.Component {
        constructor() {
          super();
          this.state = {
            auth: false,
            user: "",
            token: ""
          };
          this.setAuthenticate = this.setAuthenticate.bind(this);
          this.handleLogout = this.handleLogout.bind(this);
        }

        setAuthenticate = (status, auth_user, token) => {
          this.setState({
            user: auth_user,
            auth: true,
            token: token
          });
        };
        // Function to logout.
        handleLogout = () => {
          fetch(url + "logout", {
            method: "GET",
            mode: "cors",
            headers: {
              "Content-type": "application/json",
              Authorization: "Bearer " + this.state.token
            },
            cache: "no-cache"
          }).then(
            this.setState({
              token: "",
              user: "",
              auth: false
            })
          );
        };

        render() {
          return (
            <div className="App">
              <MuiThemeProvider>
                <Paper className="paper">
                  {this.state.auth ? (
                    <MainMenu
                      user={this.state.user}
                      token={this.state.token}
                      onLogout={this.handleLogout}
                    />
                  ) : (
                    <LoginForm onAuthenticate={this.setAuthenticate} />
                  )}
                </Paper>
              </MuiThemeProvider>
            </div>
          );
        }
      }

      class MainMenu extends React.Component {
        constructor(props) {
          super(props);
          this.state = {
            selectedUser: this.props.user,
            currentUser: this.props.user,
            users: [],
            handleUsers: false,
            handleEvents: false,
            token: this.props.token,
            showDialog: false
          };
          this.handleDialogUpdate = this.handleDialogUpdate.bind(this);
        }
        // Handles the logging out
        handleLogout = () => {
          this.props.onLogout();
        };
        // Handles the closing and opening of user list component
        handleUsers = () => {
          this.setState({
            handleUsers: !this.state.handleUsers
          });
        };
        // Handles the closing and opening of event component
        handleEvents = () => {
          this.setState({
            handleEvents: !this.state.handleEvents
          });
        };

        // Handles dialog user editing. Gets updated user data from dialog component
        handleDialogUpdate = user => {
          console.log("Called dialog update.");
          if (user !== "undefined") {
            fetch(url + "user/" + user.userId, {
              method: "PUT",
              mode: "cors",
              headers: {
                "Content-type": "application/json",
                Authorization: "Bearer " + this.state.token
              },
              cache: "no-cache",
              body: JSON.stringify(user)
            });
            console.log(user);
          }
          this.handleDialog();
        };

        // Handles dialog closing
        handleDialog = () => {
          this.setState({
            showDialog: !this.state.showDialog
          });
        };

        render() {
          return (
            <MuiThemeProvider>
              <Paper className="paper">
                <AppBar position="static">
                  <Toolbar>
                    <Typography variant="h6" color="inherit">
                      Settings
                    </Typography>
                  </Toolbar>
                </AppBar>
                <h3> Welcome to the main page of movie club! </h3>
                {this.state.currentUser !== undefined ? (
                  <div>
                    <p> Logged in as {this.state.currentUser.email}</p>
                    <Button onClick={this.handleEvents}>Upcoming events</Button>
                    <Button onClick={this.handleUsers}>List of users</Button>
                    <Button onClick={this.handleDialog}>
                      Edit your account info
                    </Button>
                    <Button>Pay membership fee</Button>
                    <Button onClick={this.handleLogout}>Log out</Button>
                    {this.state.handleEvents && (
                      <EventList user={this.state.currentUser} />
                    )}
                    {this.state.handleUsers && (
                      <UserList
                        token={this.state.token}
                        user={this.state.currentUser}
                      />
                    )}
                    {this.state.showDialog && (
                      <EditUserDialog
                        onEdit={this.handleDialogUpdate}
                        onCancel={this.handleDialog}
                        targetUser={this.state.selectedUser}
                        currentUser={this.state.currentUser}
                      />
                    )}
                  </div>
                ) : null}
              </Paper>
            </MuiThemeProvider>
          );
        }
      }
      // Class for displaying user list and some functionality.
      class UserList extends React.Component {
        constructor(props) {
          super(props);
          this.state = {
            admin: this.props.user.role,
            currentUser: this.props.user,
            token: this.props.token,
            users: [],
            message: "",
            showDialog: false,
            selectedUser: ""
          };
        }
        componentDidMount() {
          this.getAllUsers();
        }

        // Handles dialog user editing. Gets updated user data from dialog component
        handleDialogUpdate = user => {
          if (user !== "undefined") {
            fetch(url + "user/" + user.userId, {
              method: "PUT",
              mode: "cors",
              headers: {
                "Content-type": "application/json",
                Authorization: "Bearer " + this.state.token
              },
              cache: "no-cache",
              body: JSON.stringify(user)
            });
          }
          this.handleDialog();
        };

        // Handles dialog closing
        handleDialog = () => {
          this.setState({
            showDialog: !this.state.showDialog
          });
        };

        // Fetch all users.
        getAllUsers = () => {
          fetch("http://localhost:3000/api/user", {
            method: "GET",
            mode: "cors",
            headers: {
              "Content-type": "application/json",
              Authorization: "Bearer " + this.state.token
            },
            cache: "no-cache"
          }).then(res => {
            res.json().then(body => {
              if (res.status == 200) {
                this.setState({
                  users: body.message
                });
              } else {
                this.setState({
                  message: JSON.stringify(body.message)
                });
              }
            });
          });
        };

        editUser = user => () => {
          this.setState({
            selectedUser: user,
            showDialog: !this.state.showDialog
          });
        };

        // Deletes selected user
        deleteUser = id => () => {
          fetch("http://localhost:3000/api/user/" + id, {
            method: "DELETE",
            mode: "cors",
            headers: {
              "Content-type": "application/json",
              Authorization: "Bearer " + this.state.token
            },
            cache: "no-cache"
          }).then(res => {
            res.json().then(body => {
              // If deletion is succesfull, update userlist.
              if (res.status == 200) {
                this.getAllUsers();
              } else {
                // If deletion failed, show error message.
                this.setState({
                  message: body.message
                });
              }
            });
          });
        };

        render() {
          return (
            <MuiThemeProvider>
              <Paper>
                <div>
                  {/* List all users */}
                  {this.state.users.map((user, key) => (
                    <ul key={user.id}>
                      <li>
                        <b> Email:</b> {user.email}
                        <b> Role:</b> {user.role ? <u> Admin </u> : "Basic"}
                        {/*If the user is admin, show if the users have paid and two buttons for editing and deleting the users.*/}
                        {this.state.admin ? (
                          <div>
                            <div>
                              <b> Paid: </b> {user.paid ? "Yes" : "No"}
                            </div>
                            <Button
                              onClick={this.editUser(user)}
                              className="btn"
                            >
                              Edit user
                            </Button>
                            <Button
                              onClick={this.deleteUser(user.userId)}
                              className="btn"
                            >
                              Delete user
                            </Button>
                          </div>
                        ) : null}
                      </li>
                    </ul>
                  ))}
                  {this.state.showDialog ? (
                    <EditUserDialog
                      onEdit={this.handleDialogUpdate}
                      onCancel={this.handleDialog}
                      targetUser={this.state.selectedUser}
                      currentUser={this.state.currentUser}
                    />
                  ) : null}
                </div>
              </Paper>
            </MuiThemeProvider>
          );
        }
      }

      class LoginForm extends React.Component {
        constructor(props) {
          super(props);
          this.state = {
            email: "",
            password: "",
            showRegister: false,
            message: ""
          };
          this.handleRegister = this.handleRegister.bind(this);
        }

        auth = (status, user, token) => {
          this.props.onAuthenticate(status, user, token);
        };

        // Logs the user in.
        login = event => {
          // Create an user object
          var user = {
            email: this.state.email,
            password: this.state.password
          };
          // Send ajax call to server with username and password.
          fetch("http://localhost:3000/api/login", {
            credentials: "same-origin",
            headers: {
              "Content-Type": "application/json"
            },
            method: "POST",
            body: JSON.stringify(user)
          }).then(res => {
            res.json().then(body => {
              if (res.status == 200) {
                this.auth(res.status, body.message, body.token);
              } else {
                this.setState({
                  message: body.message
                });
              }
            });
          });
        };
        // Handle text field changes
        handleChange = name => event => {
          this.setState({
            [name]: event.target.value
          });
        };
        // Called when registration is done. Update state of message and close registration tab.
        handleRegister = message => {
          this.setState({
            message: message,
            showRegister: false
          });
        };
        // Handles the opening and closing of registration tab.
        toggleRegister = event => {
          this.setState({
            showRegister: !this.state.showRegister
          });
        };

        render() {
          return (
            <MuiThemeProvider>
              <Paper className="paper">
                <h2> Movie club member login </h2>
                <div>{this.state.message}</div>
                <TextField
                  label="Email"
                  value={this.state.email}
                  onChange={this.handleChange("email")}
                />
                <TextField
                  label="Password"
                  value={this.state.password}
                  onChange={this.handleChange("password")}
                />
                <Button onClick={this.login}>Login</Button>
                <Button onClick={this.toggleRegister}>Register</Button>
                <Button onClick={this.guestlogin}>Continue as guest</Button>
                <div>
                  {this.state.showRegister && (
                    <RegisterForm onClose={this.handleRegister} />
                  )}
                </div>
              </Paper>
            </MuiThemeProvider>
          );
        }
      }

      // A dialog component to edit selected user.
      class EditUserDialog extends React.Component {
        constructor(props) {
          super(props);
          this.state = {
            currentUser: this.props.currentUser,
            user: this.props.targetUser
          };
        }

        handleCancel = () => {
          this.props.onCancel();
        };

        handleEdit = () => {
          this.props.onEdit(this.state.user);
        };

        // Handles text changes and saves the edited user data into array
        handleChange = field => event => {
          // Copy the user from state
          var user = this.state.user;
          // Change the given parameter with given value
          user[field] = event.currentTarget.value;

          // Set user into state
          this.setState({
            user: user
          });
        };
        render() {
          return (
            <Dialog open={true} onClose={this.handleDialog}>
              <DialogTitle> Edit user information </DialogTitle>
              <DialogContent>
                <div>
                  <TextField
                    value={this.state.user.email}
                    label="Email"
                    onChange={this.handleChange("email")}
                  />
                </div>
                <div>
                  <TextField
                    label="Password"
                    onChange={this.handleChange("password")}
                  />
                </div>
                {/* Show optional editing fields if the user is admin */}
                {this.state.currentUser.role == 1 ? (
                  <div>
                    <div>
                      <TextField
                        value={this.state.user.paid}
                        label="Paid"
                        onChange={this.handleChange("paid")}
                        inputProps={{ maxLength: 5 }}
                      />
                    </div>
                    <div>
                      <TextField
                        value={this.state.user.role}
                        label="Role"
                        onChange={this.handleChange("role")}
                        inputProps={{ maxLength: 1 }}
                      />
                    </div>
                  </div>
                ) : null}
              </DialogContent>

              <DialogActions>
                <Button
                  onClick={this.handleEdit}
                  variant="outlined"
                  color="primary"
                >
                  Edit
                </Button>

                <Button
                  onClick={this.handleCancel}
                  variant="outlined"
                  color="primary"
                >
                  Cancel
                </Button>
              </DialogActions>
            </Dialog>
          );
        }
      }

      class RegisterForm extends React.Component {
        constructor(props) {
          super(props);
          this.state = {
            email: "",
            password: "",
            role: ""
          };
        }

        // Handle text field changes
        handleChange = name => event => {
          this.setState({
            [name]: event.target.value
          });
        };

        // Registers an user to the system.
        register = () => {
          // Create an user object
          var user = {
            email: this.state.email,
            password: this.state.password,
            role: this.state.role
          };
          // Send ajax call to server with username and password.
          fetch("http://localhost:3000/api/user", {
            credentials: "same-origin",
            headers: {
              "Content-Type": "application/json"
            },
            method: "POST",
            body: JSON.stringify(user)
          }).then(res => {
            res.json().then(body => {
              this.props.onClose(body.message);
            });
          });
        };

        render() {
          return (
            <MuiThemeProvider>
              <Paper>
                <TextField
                  label="Email"
                  value={this.state.email}
                  onChange={this.handleChange("email")}
                />

                <TextField
                  label="Password"
                  value={this.state.password}
                  onChange={this.handleChange("password")}
                />

                <TextField
                  label="Role"
                  value={this.state.role}
                  onChange={this.handleChange("role")}
                />

                <Button onClick={this.register}>Register</Button>
              </Paper>
            </MuiThemeProvider>
          );
        }
      }
      class EventList extends React.Component {
        constructor(props) {
          super(props);
          this.state = {
            currentUser: this.props.user,
            events: []
          };
        }
        /* Fetch events from server */
        componentDidMount() {
          fetch("http://localhost:3000/api/events")
            .then(res => res.json())
            .then(json => this.setState({ events: json }));
        }
        render() {
          return (
            <MuiThemeProvider>
              <Paper>
                <div>
                  {this.state.events.map(event => (
                    <ul key={event.key}>
                      <li>
                        <b>What? </b> {event.name}
                        <b>Where? </b>
                        {/* Check if the user has logged in and display information depending on that*/}
                        {this.state.currentUser !== undefined
                          ? event.location
                          : "Information only available for registered users"}
                        <b>When? </b> {event.date}
                        <b>Cost? </b> {event.price} euros
                      </li>
                    </ul>
                  ))}
                </div>
              </Paper>
            </MuiThemeProvider>
          );
        }
      }

      ReactDOM.render(<App />, document.getElementById("app"));
    </script>
  </body>
</html>
